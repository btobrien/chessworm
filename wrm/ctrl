#!/bin/bash

clear
stty -echo
tput civis

graph=${1:-default}

cd $(dirname $0)
modl_fifo=.impl/wrm/ctrl/fifos/$$
mkdir -p $(dirname $modl_fifo)
mkfifo $modl_fifo

hist_file=$HOME/.impl/wrm/state/$graph/hist.txt
mkdir -p $(dirname $hist_file)
echo '-'>$hist_file

./modl $graph <$modl_fifo  | tee -a $hist_file | ./view &

trap "echo exit >$modl_fifo; rm -f $modl_fifo; stty echo; tput cnorm" EXIT

while read -n1 key; do

	if [ "$key" == ':' ]; then
		tput cup $(tput lines) 0
		tput cnorm
		stty echo
		read -p':' -e line;
		stty -echo
		tput civis

		if [ "line" == '' ]; then
			continue
		fi

		if [ "$line" = 'q' ]; then
			clear
			exit
		fi

		if [ "$line" == 'vim' ]; then
			vim ~/.vimrc
			continue
		fi

		clear
		echo "echo $line" >$modl_fifo
		continue
	fi

	if [ "$key" == '/' ]; then
		tput cup $(tput lines) 0
		printf '/'
		move=''
		while true; do
			read -n1 key
			if [ "$key" == '' ]; then
				break
			fi
			printf $key
			move=$move$key
		done

		if [ "$move" == '' ]; then
			continue
		fi

		echo move "$(tail -1 <$hist_file)" $move >$modl_fifo
		continue
	fi

	if [ "$key" == 'f' ]; then
		echo "flip"
	fi

done
																																					
